<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å•†å“é¸æŠ</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .search-container { margin-bottom: 10px; }
    .button-area { margin-top: 10px; text-align: right; }
    .button-area button { margin-left: 5px; }
  </style>
  <script>
    // URLã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…ƒã«é¸æŠçŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã«æœ€åˆã«å–å¾—
    let selectedFromURL = [];

    function fetchProducts() {
      const keyword = document.getElementById('searchBox').value;

      const xhr = new XMLHttpRequest();
      xhr.open("GET", "select.php?keyword=" + encodeURIComponent(keyword), true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          const response = JSON.parse(xhr.responseText);
          renderTable(response.products);
          renderUpdateDate(response.latest_updated_at);
        }
      };
      xhr.send();
    }

    function renderTable(data) {
      const tableDiv = document.getElementById("results");

      if (!Array.isArray(data)) {
        tableDiv.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™</p>";
        console.error("ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿:", data);
        return;
      }

      if (data.length === 0) {
        tableDiv.innerHTML = "<p>å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>";
        return;
      }

      let html = "<table><tr><th></th><th>å•†å“å</th></tr>";

      for (let item of data) {
        const isChecked = selectedFromURL.includes(item.id.toString()) ? "checked" : "";
        html += `<tr>
          <td><input type='checkbox' name='product[]' value='${item.id}' ${isChecked}></td>
          <td>${item.name}</td>
        </tr>`;
      }

      html += "</table>";
      tableDiv.innerHTML = html;
    }

    function renderUpdateDate(datetime) {
      const updateDiv = document.getElementById("updateDate");
      if (datetime) {
        const date = new Date(datetime);
        const formatted = date.getFullYear() + '/' +
          String(date.getMonth() + 1).padStart(2, '0') + '/' +
          String(date.getDate()).padStart(2, '0') + ' ' +
          String(date.getHours()).padStart(2, '0') + ':' +
          String(date.getMinutes()).padStart(2, '0');
        updateDiv.textContent = "æœ€çµ‚æ›´æ–°æ—¥æ™‚ï¼š" + formatted;
      } else {
        updateDiv.textContent = "æœ€çµ‚æ›´æ–°æ—¥æ™‚ï¼šå–å¾—ã§ãã¾ã›ã‚“";
      }
    }

    function handleCompare() {
      const checkboxes = document.querySelectorAll("input[name='product[]']:checked");
      const selectedIds = Array.from(checkboxes).map(cb => cb.value);

      if (selectedIds.length === 0) {
        alert("å•†å“ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (selectedIds.length === 1) {
        window.location.href = `details.html?id=${selectedIds[0]}`;
      } else {
        const params = selectedIds.map((id, index) => `id${index + 1}=${id}`).join("&");
        window.location.href = `sum.php?${params}`;
      }
    }

    // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹å¾©å…ƒç”¨URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†
    function extractSelectedIdsFromURL() {
      const params = new URLSearchParams(window.location.search);
      selectedFromURL = [];
      for (const [key, value] of params.entries()) {
        if (/^id\d+$/.test(key)) {
          selectedFromURL.push(value);
        }
      }
    }

    window.onload = function () {
      extractSelectedIdsFromURL();
      fetchProducts();
    };
  </script>
</head>
<body>
  <h2>å•†å“é¸æŠ</h2>
  <p>å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
    å•†å“åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®å•†å“ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
    è¤‡æ•°å•†å“ã®åˆè¨ˆé‡‘é¡ã‚’æ¯”è¼ƒã—ãŸã„å ´åˆã¯å·¦å´ã®æ ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
  </p>

  <div id="updateDate" style="text-align: right;">æœ€çµ‚æ›´æ–°æ—¥æ™‚ï¼šå–å¾—ä¸­...</div>

  <div class="search-container">
    <input type="text" id="searchBox" onkeyup="fetchProducts()" placeholder="ğŸ”æ¤œç´¢">
  </div>

  <div id="results"></div>

  <div class="button-area">
    <button onclick="handleCompare()">æ¯”è¼ƒ</button>
    <button onclick="location.href='suii.php'">æ¨ç§»</button>
  </div>
</body>
</html>
